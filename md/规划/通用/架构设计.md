# 视频合并工具 - 架构设计

## 概述

基于 MVVM 架构的视频合并工具，核心功能是将多个视频文件按顺序合并为一个输出文件。

## 模块划分

| 模块 | 职责 |
|------|------|
| 主页模块 | 视频列表管理、排序、生成操作 |
| 设置模块 | FFmpeg 路径配置 |
| FFmpeg 模块 | 命令执行、进程管理 |
| 持久化模块 | 用户偏好存储 |

## 数据流

```
用户操作 → View → ViewModel → Service/Repository
                      ↓
状态更新 ← View ← ViewModel ← Service/Repository
```

---

## 主页模块

### 核心实体

```dart
/// 视频项
class VideoItem {
  final String id;
  final String filePath;
  final String fileName;
  
  VideoItem({
    required this.id,
    required this.filePath,
    required this.fileName,
  });
}

/// 输出配置
class OutputConfig {
  final String baseName;
  final String extension;
  
  OutputConfig({
    required this.baseName,
    required this.extension,
  });
  
  String get fullName => '$baseName.$extension';
}

/// 生成状态
enum GenerateState {
  idle,
  running,
  success,
  failed,
}

/// 生成结果
class GenerateResult {
  final GenerateState state;
  final String output;
  final String? errorMessage;
  
  GenerateResult({
    required this.state,
    required this.output,
    this.errorMessage,
  });
}
```

### ViewModel 接口

```dart
/// 主页 ViewModel 契约
abstract class IHomeViewModel {
  /// 视频列表（有序）
  List<VideoItem> get videoItems;
  
  /// 输出配置
  OutputConfig get outputConfig;
  
  /// 生成结果
  GenerateResult? get generateResult;
  
  /// 是否正在生成
  bool get isGenerating;
  
  /// 添加视频文件
  void addVideos(List<String> filePaths);
  
  /// 删除视频
  void removeVideo(String id);
  
  /// 重新排序（拖动完成后调用）
  void reorderVideo(int oldIndex, int newIndex);
  
  /// 更新输出文件名（不含后缀）
  void updateOutputBaseName(String baseName);
  
  /// 更新输出后缀（自动持久化）
  void updateOutputExtension(String extension);
  
  /// 开始生成
  Future<void> startGenerate();
  
  /// 中断生成
  void cancelGenerate();
  
  /// 清除生成结果
  void clearResult();
}
```

### View 交互规范

| 操作 | 行为 | 确认 |
|------|------|------|
| 添加视频 | 点击按钮或拖放文件 | 无 |
| 删除视频 | 点击删除按钮 | 无 |
| 拖动排序 | 拖动专用拖动手柄 | 无 |
| 修改文件名 | 直接编辑输入框 | 无 |
| 修改后缀 | 直接编辑/选择 | 无，自动保存 |
| 确认生成 | 点击生成按钮 | 无 |
| 中断生成 | 点击取消按钮 | 无 |

### 列表项布局

```
┌─────────────────────────────────────────────────────┐
│ ⋮⋮  video_001.mp4                           [删除] │
│ ⋮⋮  video_002.mp4                           [删除] │
│ ⋮⋮  video_003.mp4                           [删除] │
└─────────────────────────────────────────────────────┘
  ↑                                              ↑
拖动手柄                                      删除按钮
```

### 输出文件名区域

```
┌─────────────────────────────────────────────────────┐
│ 输出: [  merged_video  ] . [ mp4 ▼]                │
└─────────────────────────────────────────────────────┘
        ↑ 可编辑文件名        ↑ 可编辑/选择后缀
```

---

## 设置模块

### 实体

```dart
/// 应用设置
class AppSettings {
  final String ffmpegPath;
  
  AppSettings({
    required this.ffmpegPath,
  });
}
```

### ViewModel 接口

```dart
/// 设置 ViewModel 契约
abstract class ISettingsViewModel {
  /// 当前设置
  AppSettings get settings;
  
  /// FFmpeg 路径是否有效
  bool get isFFmpegValid;
  
  /// 更新 FFmpeg 路径
  Future<void> updateFFmpegPath(String path);
  
  /// 验证 FFmpeg 路径
  Future<bool> validateFFmpegPath(String path);
  
  /// 浏览选择 FFmpeg 路径
  Future<void> browseFFmpegPath();
}
```

---

## FFmpeg 模块

### 服务接口

```dart
/// FFmpeg 执行回调
typedef OutputCallback = void Function(String output);

/// FFmpeg 服务契约
abstract class IFFmpegService {
  /// 设置 FFmpeg 可执行文件路径
  set ffmpegPath(String path);
  
  /// 验证 FFmpeg 是否可用
  Future<bool> validate();
  
  /// 执行原始命令
  /// [arguments] 命令参数列表
  /// [onOutput] 实时输出回调
  /// 返回退出码
  Future<int> execute({
    required List<String> arguments,
    OutputCallback? onOutput,
  });
  
  /// 中断当前执行
  void cancel();
  
  /// 是否正在执行
  bool get isRunning;
}

/// 视频合并服务契约
abstract class IVideoConcatService {
  /// 合并视频文件
  /// [inputPaths] 输入文件路径列表（有序）
  /// [outputPath] 输出文件路径
  /// [onOutput] 实时输出回调
  Future<int> concat({
    required List<String> inputPaths,
    required String outputPath,
    OutputCallback? onOutput,
  });
  
  /// 中断合并
  void cancel();
}
```

---

## 持久化模块

### Repository 接口

```dart
/// 用户偏好存储契约
abstract class IPreferencesRepository {
  /// 获取上次使用的输出后缀
  Future<String> getLastExtension();
  
  /// 保存输出后缀
  Future<void> saveLastExtension(String extension);
  
  /// 获取 FFmpeg 路径
  Future<String?> getFFmpegPath();
  
  /// 保存 FFmpeg 路径
  Future<void> saveFFmpegPath(String path);
}
```

---

## 自动生成输出文件名规则

| 条件 | 生成规则 |
|------|----------|
| 无视频 | 空 |
| 单个视频 | `{视频文件名}_merged` |
| 多个视频 | `{首个视频文件名}_merged` |

后缀默认使用持久化存储的值，首次使用时默认为 `mp4`。
